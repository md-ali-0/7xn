<div class="d-flex justify-between align-center mb-3">
    <h1>Package Management</h1>
    <a href="/admin/packages/create" class="btn btn-success">Create New Package</a>
</div>

<% if (success) { %>
    <div class="alert alert-success"><%= success %></div>
<% } %>

<% if (error) { %>
    <div class="alert alert-error"><%= error %></div>
<% } %>

<!-- Statistics Cards -->
<div class="dashboard-grid mb-3">
    <div class="stat-card" style="background: linear-gradient(135deg, #007bff, #0056b3);">
        <div class="stat-number"><%= stats.total %></div>
        <div class="stat-label">Total Packages</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #28a745, #218838);">
        <div class="stat-number"><%= stats.active %></div>
        <div class="stat-label">Active Packages</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #6c757d, #545b62);">
        <div class="stat-number"><%= stats.inactive %></div>
        <div class="stat-label">Inactive Packages</div>
    </div>
</div>

<div class="card">
    <div class="table-responsive">
        <table class="table table-stacked">
            <thead>
                <tr>
                    <th data-label="Package Name">Package Name</th>
                    <th data-label="Email Credits">Email Credits</th>
                    <th data-label="Concurrency">Concurrency</th>
                    <th data-label="Users">Users</th>
                    <th data-label="Status">Status</th>
                    <th data-label="Created">Created</th>
                    <th data-label="Actions">Actions</th>
                </tr>
            </thead>
            <tbody>
                <% packages.forEach(pkg => { %>
                    <tr>
                        <td data-label="Package Name">
                            <strong><%= pkg.name %></strong>
                        </td>
                        <td data-label="Email Credits"><%= pkg.emailCredits.toLocaleString() %></td>
                        <td data-label="Concurrency"><%= pkg.concurrencyLimit %></td>
                        <td data-label="Users">
                            <span class="<%= pkg.userCount > 0 ? 'text-primary' : 'text-muted' %>">
                                <%= pkg.userCount %> users
                            </span>
                        </td>
                        <td data-label="Status">
                            <span class="<%= pkg.isActive ? 'text-success' : 'text-danger' %>">
                                <%= pkg.isActive ? 'Active' : 'Inactive' %>
                            </span>
                        </td>
                        <td data-label="Created"><%= pkg.createdAt.toLocaleDateString() %></td>
                        <td data-label="Actions">
                            <div class="d-flex gap-1">
                                <a href="/admin/packages/view/<%= pkg._id %>" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">View</a>
                                <a href="/admin/packages/edit/<%= pkg._id %>" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Edit</a>
                                <% if (pkg.userCount === 0) { %>
                                    <form action="/admin/packages/delete/<%= pkg._id %>" method="POST" style="display: inline;">
                                        <button 
                                            type="submit" 
                                            class="btn btn-danger" 
                                            style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                                            data-confirm-delete="Are you sure you want to delete package '<%= pkg.name %>'?"
                                        >
                                            Delete
                                        </button>
                                    </form>
                                <% } else { %>
                                    <button 
                                        class="btn btn-danger" 
                                        style="padding: 0.25rem 0.5rem; font-size: 0.875rem; opacity: 0.5;" 
                                        disabled
                                        title="Cannot delete package with assigned users"
                                    >
                                        Delete
                                    </button>
                                <% } %>
                            </div>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<% if (totalPages > 1) { %>
    <div class="pagination-container">
        <div class="pagination-info">
            Showing page <%= currentPage %> of <%= totalPages %> (Total <%= totalPackages %> packages)
        </div>
        <div class="pagination-controls">
            <% if (hasPrevPage) { %>
                <a href="/admin/packages?page=1" class="btn btn-secondary pagination-btn">First</a>
                <a href="/admin/packages?page=<%= prevPage %>" class="btn btn-secondary pagination-btn">Previous</a>
            <% } %>
            
            <% 
                // Calculate page range to display
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);
                
                // Adjust if near the beginning or end
                if (currentPage <= 3) {
                    endPage = Math.min(totalPages, 5);
                } else if (currentPage >= totalPages - 2) {
                    startPage = Math.max(1, totalPages - 4);
                }
            %>
            
            <% for (let i = startPage; i <= endPage; i++) { %>
                <% if (i === currentPage) { %>
                    <span class="btn btn-primary pagination-btn active"><%= i %></span>
                <% } else { %>
                    <a href="/admin/packages?page=<%= i %>" class="btn btn-secondary pagination-btn"><%= i %></a>
                <% } %>
            <% } %>
            
            <% if (hasNextPage) { %>
                <a href="/admin/packages?page=<%= nextPage %>" class="btn btn-secondary pagination-btn">Next</a>
                <a href="/admin/packages?page=<%= totalPages %>" class="btn btn-secondary pagination-btn">Last</a>
            <% } %>
        </div>
    </div>
<% } %>

<div class="mt-3">
    <a href="/admin/users" class="btn btn-secondary">Manage Users</a>
</div>